# v0.7.0 Day 3-4: Glob Optimization Implementation

**Date**: 2025-10-23 (Week 1 Day 3-4)
**Status**: üöÄ IN PROGRESS
**Goal**: Reduce file scanning time by 40-50% through glob optimization

---

## üìã Current Performance Issues

Based on Day 1 profiling (100 iterations, 145ms total):

**Top Bottlenecks**:
1. `posix.scandir`: 67ms (46%)
2. `pathlib.glob` & `_select_from`: 83ms (57%)
3. `posix.stat`: 10ms (7%)

**Problem**: Each framework detection performs multiple glob operations independently, leading to redundant file system scans.

---

## üéØ Optimization Strategies

### Strategy 1: Single Directory Scan
**Current**: Each framework detector performs its own glob operations
**Optimized**: Scan directory once, cache results, share across all detectors

**Expected Improvement**: -40% time (67ms ‚Üí 40ms for scandir)

### Strategy 2: Early Exit on High Confidence
**Current**: Always check all frameworks in sequence
**Optimized**: Stop detection after high confidence match (>0.8)

**Expected Improvement**: -20% time (avoid unnecessary scans)

### Strategy 3: Limit Glob Depth
**Current**: Unlimited depth for some glob patterns
**Optimized**: Limit to 2-3 levels deep for performance

**Expected Improvement**: -10% time for deep directories

---

## üíª Implementation Plan

### Phase 1: Directory Scan Caching (Day 3)

Add a caching layer for directory listings:

```python
from pathlib import Path
from typing import Dict, List, Set
import os

class DirectoryScanner:
    """Cached directory scanner to reduce redundant file system operations."""

    def __init__(self, project_path: Path):
        self.project_path = project_path
        self._file_cache: Dict[str, List[Path]] = {}
        self._dir_cache: Set[Path] = set()

    def scan_once(self):
        """Perform single directory scan and cache results."""
        # Scan root directory
        try:
            entries = list(self.project_path.iterdir())
        except (PermissionError, OSError):
            return

        for entry in entries:
            if entry.is_file():
                # Cache by extension
                ext = entry.suffix.lower()
                if ext not in self._file_cache:
                    self._file_cache[ext] = []
                self._file_cache[ext].append(entry)

                # Cache specific important files
                name = entry.name.lower()
                if name not in self._file_cache:
                    self._file_cache[name] = []
                self._file_cache[name].append(entry)

            elif entry.is_dir():
                self._dir_cache.add(entry)

    def has_file(self, filename: str) -> bool:
        """Check if file exists (cached)."""
        return filename.lower() in self._file_cache

    def has_dir(self, dirname: str) -> bool:
        """Check if directory exists (cached)."""
        dir_path = self.project_path / dirname
        return dir_path in self._dir_cache

    def get_files_by_extension(self, ext: str) -> List[Path]:
        """Get all files with extension (cached)."""
        return self._file_cache.get(ext.lower(), [])

    def get_file(self, filename: str) -> Path:
        """Get specific file path (cached)."""
        files = self._file_cache.get(filename.lower(), [])
        return files[0] if files else None
```

### Phase 2: Integrate Scanner into TechStackDetector (Day 3)

Modify `__init__` to create scanner:

```python
class TechStackDetector:
    def __init__(self, project_path: str):
        self.project_path = Path(project_path).resolve()

        # NEW: Create directory scanner
        self.scanner = DirectoryScanner(self.project_path)
        self.scanner.scan_once()  # Scan once at initialization
```

### Phase 3: Update Detection Methods (Day 3-4)

**Before (Next.js detection)**:
```python
# Check for package.json
package_json = self.project_path / "package.json"
if not package_json.exists():
    return None

# Check for next.config.js/ts
if (self.project_path / "next.config.js").exists() or \
   (self.project_path / "next.config.ts").exists() or \
   (self.project_path / "next.config.mjs").exists():
    indicators.append("next.config.* exists: +0.3")
    confidence += 0.3

# Check for app/ or pages/ directory
has_app_dir = (self.project_path / "app").is_dir()
has_pages_dir = (self.project_path / "pages").is_dir()
```

**After (Optimized)**:
```python
# Check for package.json (cached)
if not self.scanner.has_file("package.json"):
    return None

package_json = self.scanner.get_file("package.json")

# Check for next.config.* (cached)
if self.scanner.has_file("next.config.js") or \
   self.scanner.has_file("next.config.ts") or \
   self.scanner.has_file("next.config.mjs"):
    indicators.append("next.config.* exists: +0.3")
    confidence += 0.3

# Check for app/ or pages/ directory (cached)
has_app_dir = self.scanner.has_dir("app")
has_pages_dir = self.scanner.has_dir("pages")
```

### Phase 4: Early Exit on High Confidence (Day 4)

Modify detect() method:

```python
def detect(self) -> Optional[DetectionResult]:
    """Detect tech stack with early exit optimization."""
    logger.info("Starting tech stack detection")

    # Try detection in order of specificity
    # EARLY EXIT if confidence > 0.8
    detectors = [
        self._detect_nextjs,
        self._detect_react,
        self._detect_vue,
        self._detect_fastapi,
        self._detect_django,
        self._detect_flask,
        self._detect_vanilla_php_web,
        self._detect_python_ml,
        self._detect_ios_swift,
        self._detect_go,
        self._detect_flutter,
    ]

    for detector in detectors:
        result = detector()
        if result and result.confidence >= 0.8:
            # High confidence match, stop checking
            logger.info(f"‚úì Early exit: {result.framework} (confidence: {result.confidence:.2f})")
            return result

    # If no high-confidence match, return best match
    # (existing logic)
    ...
```

---

## üìä Expected Performance Impact

### Current Performance (v0.6.0)

| Framework | Time (Œºs) | Status |
|-----------|-----------|--------|
| Go | 448.9 | ‚ö†Ô∏è SLOW |
| PHP | 536.6 | ‚ö†Ô∏è SLOW |
| iOS Swift | 792.6 | ‚ùå VERY SLOW |
| Flutter | 953.6 | ‚ùå VERY SLOW |
| Python ML | 897.6 | ‚ùå VERY SLOW |

### Target Performance (v0.7.0)

| Framework | Current | Target | Improvement |
|-----------|---------|--------|-------------|
| Go | 448.9Œºs | <250Œºs | -44% |
| PHP | 536.6Œºs | <250Œºs | -53% |
| iOS Swift | 792.6Œºs | <500Œºs | -37% |
| Flutter | 953.6Œºs | <500Œºs | -48% |
| Python ML | 897.6Œºs | <500Œºs | -44% |

### Optimization Breakdown

**Strategy 1: Single Scan** (-40% scandir time):
- Before: 67ms / 100 iterations = 670Œºs per iteration
- After: 40ms / 100 iterations = 400Œºs per iteration
- **Savings: 270Œºs**

**Strategy 2: Early Exit** (-20% average):
- Applies when high confidence match found early
- Average savings: ~100Œºs

**Strategy 3: Limit Depth** (-10%):
- Applies to deep directory structures
- Average savings: ~50Œºs

**Total Expected Savings**: 270 + 100 + 50 = **420Œºs**

### Projected Results

| Framework | Current | Optimized | Achieved? |
|-----------|---------|-----------|-----------|
| Go | 448.9Œºs | ~150Œºs | ‚úÖ < 250Œºs |
| PHP | 536.6Œºs | ~180Œºs | ‚úÖ < 250Œºs |
| iOS Swift | 792.6Œºs | ~400Œºs | ‚úÖ < 500Œºs |
| Flutter | 953.6Œºs | ~530Œºs | ‚ö†Ô∏è Close |
| Python ML | 897.6Œºs | ~480Œºs | ‚úÖ < 500Œºs |

**Expected: 8/11 frameworks < 500Œºs** (close to 9/11 goal)

---

## üß™ Testing Plan

### Performance Tests

Create benchmark test to verify improvements:

```python
# tests/test_performance_v0_7.py

import pytest
from pathlib import Path
import time

def test_directory_scanner_performance(go_project, benchmark):
    """Test DirectoryScanner performance."""
    from detect_stack import DirectoryScanner

    def scan():
        scanner = DirectoryScanner(go_project)
        scanner.scan_once()
        return scanner

    result = benchmark(scan)

    # Should be fast (<100Œºs)
    assert benchmark.stats.stats.mean < 0.0001  # 100Œºs


def test_cached_file_lookup_performance(nextjs_project, benchmark):
    """Test cached file lookup performance."""
    from detect_stack import DirectoryScanner

    scanner = DirectoryScanner(nextjs_project)
    scanner.scan_once()

    def lookup():
        return scanner.has_file("package.json")

    result = benchmark(lookup)

    # Should be very fast (<1Œºs)
    assert benchmark.stats.stats.mean < 0.000001  # 1Œºs


def test_optimized_detection_performance(go_project, benchmark):
    """Test optimized Go detection performance."""
    from detect_stack import detect_tech_stack

    result = benchmark(detect_tech_stack, str(go_project))

    # Should meet target (<250Œºs)
    assert benchmark.stats.stats.mean < 0.000250  # 250Œºs
```

### Before/After Comparison

Run benchmarks before and after optimization:

```bash
# Baseline (v0.6.0)
pytest tests/test_performance.py::TestDetectionPerformance::test_go_detection_speed --benchmark-only

# Optimized (v0.7.0)
pytest tests/test_performance_v0_7.py::test_optimized_detection_performance --benchmark-only

# Compare
pytest-benchmark compare
```

---

## üìù Implementation Checklist

### Day 3 Morning
- [ ] Create DirectoryScanner class
- [ ] Add scan_once() method
- [ ] Add has_file(), has_dir() methods
- [ ] Add get_file(), get_files_by_extension() methods
- [ ] Write unit tests for DirectoryScanner

### Day 3 Afternoon
- [ ] Integrate DirectoryScanner into TechStackDetector.__init__()
- [ ] Update _detect_nextjs() to use scanner
- [ ] Update _detect_react() to use scanner
- [ ] Update _detect_vue() to use scanner
- [ ] Test Next.js/React/Vue detection still works

### Day 4 Morning
- [ ] Update _detect_go() to use scanner
- [ ] Update _detect_php() to use scanner
- [ ] Update _detect_ios_swift() to use scanner
- [ ] Update _detect_flutter() to use scanner
- [ ] Update _detect_python_ml() to use scanner

### Day 4 Afternoon
- [ ] Implement early exit in detect() method
- [ ] Run performance benchmarks
- [ ] Verify 8-9/11 frameworks < 500Œºs
- [ ] Update PERFORMANCE_TRACKING.md with results
- [ ] Commit optimization changes

---

## üéØ Success Criteria

**Day 3-4 Complete When**:
- ‚úÖ DirectoryScanner implemented and tested
- ‚úÖ All 11 framework detectors use scanner
- ‚úÖ Early exit logic implemented
- ‚úÖ Performance benchmarks show improvement
- ‚úÖ At least 8/11 frameworks < 500Œºs (target: 9/11)
- ‚úÖ All existing tests still pass (no regressions)

**Performance Validation**:
- ‚úÖ Go: <250Œºs (from 448.9Œºs, -44%)
- ‚úÖ PHP: <250Œºs (from 536.6Œºs, -53%)
- ‚úÖ iOS Swift: <500Œºs (from 792.6Œºs, -37%)
- ‚úÖ Python ML: <500Œºs (from 897.6Œºs, -44%)
- ‚ö†Ô∏è Flutter: Close to 500Œºs (from 953.6Œºs)

---

**Status**: üöÄ READY TO IMPLEMENT
**Next**: Implement DirectoryScanner class
**Timeline**: Day 3-4 (2 days)

**Repository**: https://github.com/SawanoLab/adaptive-claude-agents
**Version**: v0.7.0-beta (Week 1 Day 3-4)
