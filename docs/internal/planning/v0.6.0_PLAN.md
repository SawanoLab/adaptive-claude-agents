# v0.6.0-beta Development Plan

**Target Release**: November 2025
**Theme**: Coverage Improvement & Monorepo Support
**Duration**: 3-4 weeks

---

## 📋 Overview

v0.6.0-beta focuses on increasing code coverage to production-ready levels and adding monorepo support for modern workspace-based projects.

---

## 🎯 Goals

### 1. Code Coverage Enhancement
**Current**: 62.04% → **Target**: 85%+

**Breakdown by Module**:
| Module | Current | Target | Priority |
|--------|---------|--------|----------|
| detect_stack.py | 61.81% | 85% | High |
| analyze_project.py | 68.40% | 85% | Medium |
| detect_phase.py | 58.82% | 85% | High |

**Missing Coverage Areas**:
1. Error handling paths (try/except blocks)
2. Edge cases (empty files, invalid JSON/YAML)
3. Network timeout scenarios
4. Complex detection logic branches
5. File system error handling

### 2. Monorepo Support
**Current**: Single framework per project → **Target**: Multi-framework workspaces

**Workspace Managers to Support**:
1. **npm workspaces** (priority: high)
2. **pnpm workspaces** (priority: high)
3. **Yarn workspaces** (priority: medium)
4. **Lerna** (priority: low)
5. **Nx** (priority: low)

**Features**:
- Detect workspace configuration files
- Scan each workspace for frameworks
- Generate framework-specific agents per workspace
- Handle nested workspace structures
- Aggregate results in main project

### 3. CLI Enhancements
**Current**: Basic positional args → **Target**: Full argparse with help

**New Flags**:
```bash
python3 detect_stack.py --help
python3 detect_stack.py --version
python3 detect_stack.py /path --verbose
python3 detect_stack.py /path --json
python3 detect_stack.py /path --quiet
```

**Features**:
- Comprehensive help messages
- Version information display
- Verbose mode with detailed logging
- JSON output mode for CI/CD
- Quiet mode for scripts

### 4. Framework Detection Improvements
**Target**: All frameworks ≥ 60% confidence

**Frameworks to Improve**:
1. **PHP** (55% → 65%): Add more vanilla PHP indicators
2. **Flask** (70% → 75%): Better dependency detection
3. **iOS Swift** (75% → 80%): Xcode project parsing enhancement

**Enhancements**:
- Negative detection (not Laravel/Symfony for PHP)
- Framework version compatibility checks
- Deprecated dependency warnings
- Alternative framework suggestions

---

## 📅 Week-by-Week Breakdown

### Week 1 (Nov 4-10): CLI & Architecture
**Focus**: CLI enhancement + Monorepo design

**Tasks**:
1. **Day 1-2: CLI Implementation**
   - Add argparse to detect_stack.py
   - Implement --help, --version, --verbose
   - Add --json output mode
   - Write CLI unit tests

2. **Day 3-4: Monorepo Design**
   - Design workspace detection algorithm
   - Create MonorepoDetector class
   - Define workspace result structure
   - Write design document

3. **Day 5: Code Coverage Baseline**
   - Run coverage with --cov-report=html
   - Identify uncovered lines
   - Prioritize areas for testing
   - Create coverage improvement plan

**Deliverables**:
- ✅ CLI fully functional with argparse
- ✅ Monorepo architecture designed
- ✅ Coverage gap analysis complete

### Week 2 (Nov 11-17): Monorepo Implementation
**Focus**: Workspace detection + testing

**Tasks**:
1. **Day 1-2: npm/pnpm Workspaces**
   - Implement package.json workspaces parser
   - Implement pnpm-workspace.yaml parser
   - Scan workspace directories
   - Test with real monorepo projects

2. **Day 3: Yarn Workspaces**
   - Implement Yarn workspace detection
   - Handle yarn.lock parsing
   - Test with Yarn monorepos

3. **Day 4-5: Monorepo Testing**
   - Create monorepo test fixtures
   - Write integration tests (3+ workspace scenarios)
   - Test nested workspace structures
   - Validate multi-framework detection

**Deliverables**:
- ✅ npm/pnpm/Yarn workspaces supported
- ✅ 10+ monorepo tests passing
- ✅ Real-world monorepo validation

### Week 3 (Nov 18-24): Code Coverage Push
**Focus**: Test writing to reach 85%

**Tasks**:
1. **Day 1-2: detect_phase.py Coverage**
   - Test all signal detection methods
   - Test edge cases (empty git repo, no CI)
   - Test user config override scenarios
   - Target: 58% → 85%

2. **Day 3: detect_stack.py Coverage**
   - Test error handling paths
   - Test invalid file formats (corrupted JSON/YAML)
   - Test network timeouts
   - Target: 61% → 85%

3. **Day 4: analyze_project.py Coverage**
   - Test user confirmation flows
   - Test template generation errors
   - Test file system errors
   - Target: 68% → 85%

4. **Day 5: Integration Tests**
   - Add 20+ integration tests
   - Test complex real-world scenarios
   - Test error recovery mechanisms

**Deliverables**:
- ✅ Code coverage ≥ 85%
- ✅ 50+ new tests added
- ✅ All error paths covered

### Week 4 (Nov 25-Dec 1): Polish & Release
**Focus**: Documentation, testing, release prep

**Tasks**:
1. **Day 1-2: Framework Detection Enhancements**
   - Improve PHP detection (55% → 65%)
   - Improve Flask detection (70% → 75%)
   - Improve iOS detection (75% → 80%)
   - Add framework version checks

2. **Day 3: Documentation**
   - Update QUICKSTART.md with monorepo examples
   - Update TROUBLESHOOTING.md with new issues
   - Write monorepo usage guide
   - Update CLI help messages

3. **Day 4: Testing & Validation**
   - Run full test suite (target: 95% pass rate)
   - Test on real-world projects (5+ monorepos)
   - Performance benchmarks validation
   - Bug fixes

4. **Day 5: Release Preparation**
   - Update CHANGELOG.md
   - Write RELEASE_NOTES_v0.6.0-beta.md
   - Create migration guide
   - Version bump to 0.6.0-beta

**Deliverables**:
- ✅ All documentation updated
- ✅ 95%+ test pass rate
- ✅ Release notes complete
- ✅ v0.6.0-beta ready

---

## 🛠️ Technical Implementation

### 1. CLI Enhancement (argparse)

**File**: `skills/project-analyzer/detect_stack.py`

```python
import argparse
import json
import sys

def create_parser():
    parser = argparse.ArgumentParser(
        description='Detect tech stack for a project',
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog='''
Examples:
  %(prog)s .                    # Detect current directory
  %(prog)s /path/to/project     # Detect specific project
  %(prog)s . --verbose          # Verbose output
  %(prog)s . --json             # JSON output
  %(prog)s . --quiet            # Quiet mode (errors only)
        '''
    )

    parser.add_argument(
        'project_path',
        nargs='?',
        default='.',
        help='Path to project directory (default: current directory)'
    )

    parser.add_argument(
        '--version',
        action='version',
        version='%(prog)s 0.6.0-beta'
    )

    parser.add_argument(
        '--verbose', '-v',
        action='store_true',
        help='Verbose output with detailed detection process'
    )

    parser.add_argument(
        '--json',
        action='store_true',
        help='Output results in JSON format'
    )

    parser.add_argument(
        '--quiet', '-q',
        action='store_true',
        help='Quiet mode (only show errors)'
    )

    return parser

def main():
    parser = create_parser()
    args = parser.parse_args()

    # Configure logging based on flags
    if args.quiet:
        logging.basicConfig(level=logging.ERROR)
    elif args.verbose:
        logging.basicConfig(level=logging.DEBUG)
    else:
        logging.basicConfig(level=logging.INFO)

    # Detect tech stack
    result = detect_tech_stack(args.project_path)

    # Output
    if args.json:
        print(json.dumps(result.__dict__, indent=2))
    else:
        print_human_readable(result)
```

### 2. Monorepo Detection

**File**: `skills/project-analyzer/detect_monorepo.py` (NEW)

```python
from dataclasses import dataclass
from pathlib import Path
from typing import List, Optional
import json
import yaml

@dataclass
class WorkspaceInfo:
    name: str
    path: Path
    package_manager: str  # 'npm', 'pnpm', 'yarn'
    framework: Optional[str] = None
    detection_result: Optional[DetectionResult] = None

@dataclass
class MonorepoResult:
    is_monorepo: bool
    workspace_manager: Optional[str] = None
    workspaces: List[WorkspaceInfo] = None
    root_path: Path = None

class MonorepoDetector:
    def __init__(self, project_path: Path):
        self.project_path = Path(project_path)

    def detect(self) -> MonorepoResult:
        """Detect if project is a monorepo and identify workspaces."""

        # Check for npm/pnpm/Yarn workspaces
        package_json = self.project_path / "package.json"
        if package_json.exists():
            with open(package_json) as f:
                data = json.load(f)

            # npm/Yarn workspaces (in package.json)
            if "workspaces" in data:
                return self._detect_npm_workspaces(data["workspaces"])

        # Check for pnpm workspaces
        pnpm_workspace = self.project_path / "pnpm-workspace.yaml"
        if pnpm_workspace.exists():
            return self._detect_pnpm_workspaces()

        # Check for Lerna
        lerna_json = self.project_path / "lerna.json"
        if lerna_json.exists():
            return self._detect_lerna_workspaces()

        # Check for Nx
        nx_json = self.project_path / "nx.json"
        if nx_json.exists():
            return self._detect_nx_workspaces()

        return MonorepoResult(is_monorepo=False, root_path=self.project_path)

    def _detect_npm_workspaces(self, workspaces_config) -> MonorepoResult:
        """Detect npm/Yarn workspaces from package.json."""
        workspaces = []

        # workspaces can be array or object with "packages" key
        patterns = workspaces_config if isinstance(workspaces_config, list) else workspaces_config.get("packages", [])

        for pattern in patterns:
            # Glob pattern matching (e.g., "packages/*")
            for workspace_dir in self.project_path.glob(pattern):
                if workspace_dir.is_dir():
                    pkg_json = workspace_dir / "package.json"
                    if pkg_json.exists():
                        with open(pkg_json) as f:
                            pkg_data = json.load(f)

                        workspaces.append(WorkspaceInfo(
                            name=pkg_data.get("name", workspace_dir.name),
                            path=workspace_dir,
                            package_manager="npm"
                        ))

        return MonorepoResult(
            is_monorepo=True,
            workspace_manager="npm",
            workspaces=workspaces,
            root_path=self.project_path
        )

    def _detect_pnpm_workspaces(self) -> MonorepoResult:
        """Detect pnpm workspaces from pnpm-workspace.yaml."""
        workspace_file = self.project_path / "pnpm-workspace.yaml"
        with open(workspace_file) as f:
            config = yaml.safe_load(f)

        workspaces = []
        for pattern in config.get("packages", []):
            for workspace_dir in self.project_path.glob(pattern):
                if workspace_dir.is_dir():
                    pkg_json = workspace_dir / "package.json"
                    if pkg_json.exists():
                        with open(pkg_json) as f:
                            pkg_data = json.load(f)

                        workspaces.append(WorkspaceInfo(
                            name=pkg_data.get("name", workspace_dir.name),
                            path=workspace_dir,
                            package_manager="pnpm"
                        ))

        return MonorepoResult(
            is_monorepo=True,
            workspace_manager="pnpm",
            workspaces=workspaces,
            root_path=self.project_path
        )
```

### 3. Integration with analyze_project.py

```python
def analyze(self):
    """Main analysis workflow with monorepo support."""

    # 1. Check for monorepo
    monorepo_detector = MonorepoDetector(self.project_path)
    monorepo_result = monorepo_detector.detect()

    if monorepo_result.is_monorepo:
        print(f"📦 Detected {monorepo_result.workspace_manager} monorepo")
        print(f"   Found {len(monorepo_result.workspaces)} workspaces")

        # Detect framework for each workspace
        for workspace in monorepo_result.workspaces:
            result = detect_tech_stack(str(workspace.path))
            workspace.detection_result = result

            if result:
                print(f"   - {workspace.name}: {result.framework}")

        # Generate agents for each workspace
        if self._confirm_generation(monorepo_result):
            for workspace in monorepo_result.workspaces:
                if workspace.detection_result:
                    self._generate_agents_for_workspace(workspace)
    else:
        # Single project (existing flow)
        result = detect_tech_stack(str(self.project_path))
        # ... existing logic
```

---

## 🧪 Testing Strategy

### Test Files to Create/Update

1. **tests/test_cli.py** (NEW)
   - Test argparse functionality
   - Test --help, --version outputs
   - Test --json, --verbose, --quiet modes
   - Test invalid arguments handling

2. **tests/test_monorepo.py** (NEW)
   - Test npm workspaces detection
   - Test pnpm workspaces detection
   - Test Yarn workspaces detection
   - Test nested workspace structures
   - Test multi-framework scenarios

3. **tests/test_coverage_*.py** (NEW)
   - test_coverage_detect_stack.py - Edge cases
   - test_coverage_detect_phase.py - Signal detection
   - test_coverage_analyze.py - User flows

4. **tests/conftest.py** (UPDATE)
   - Add monorepo fixtures (npm, pnpm, Yarn)
   - Add complex nested structures
   - Add multi-framework monorepo fixtures

### Coverage Targets by Module

```bash
# Current coverage report
pytest --cov=skills --cov-report=term-missing

# Target: 85% overall
# - detect_stack.py: 61% → 85% (+24%)
# - detect_phase.py: 58% → 85% (+27%)
# - analyze_project.py: 68% → 85% (+17%)
```

---

## 📚 Documentation Updates

### Files to Create
1. **docs/MONOREPO_GUIDE.md** - Monorepo usage guide
2. **docs/CLI_REFERENCE.md** - Complete CLI documentation

### Files to Update
1. **docs/QUICKSTART.md** - Add monorepo examples
2. **docs/TROUBLESHOOTING.md** - Add monorepo issues
3. **docs/EXAMPLES.md** - Add 2-3 monorepo examples
4. **README.md** - Update feature list
5. **CHANGELOG.md** - v0.6.0 section

---

## 🎯 Success Criteria

### Must Have (Required for Release)
- ✅ Code coverage ≥ 85%
- ✅ npm workspaces supported
- ✅ pnpm workspaces supported
- ✅ CLI --help, --version working
- ✅ All frameworks ≥ 60% confidence
- ✅ Test pass rate ≥ 95%
- ✅ Documentation updated

### Nice to Have (Optional)
- ⭐ Yarn workspaces supported
- ⭐ Lerna detection
- ⭐ Nx detection
- ⭐ --json output mode
- ⭐ Framework version checks

### Performance
- All detection < 1500μs (including monorepo scan)
- Monorepo with 10 workspaces < 5s total

---

## 🚧 Risks & Mitigation

### Risk 1: Code Coverage Too Ambitious
**Risk**: 62% → 85% may require too many tests

**Mitigation**:
- Focus on critical paths first (detection logic)
- Accept 80% if 85% requires excessive effort
- Prioritize error handling coverage

### Risk 2: Monorepo Complexity
**Risk**: Real-world monorepos may have unexpected structures

**Mitigation**:
- Test with popular monorepo templates (Turborepo, Nx)
- Start with npm/pnpm (most common)
- Make Yarn/Lerna optional (nice-to-have)

### Risk 3: Breaking Changes
**Risk**: CLI changes may break existing scripts

**Mitigation**:
- Keep positional argument working (backward compatible)
- Add deprecation warnings if needed
- Document migration in CHANGELOG

---

## 📊 Progress Tracking

### Week 1
- [ ] CLI argparse implementation
- [ ] Monorepo architecture design
- [ ] Coverage gap analysis

### Week 2
- [ ] npm/pnpm workspace detection
- [ ] Yarn workspace detection
- [ ] Monorepo integration tests

### Week 3
- [ ] detect_phase.py coverage to 85%
- [ ] detect_stack.py coverage to 85%
- [ ] analyze_project.py coverage to 85%

### Week 4
- [ ] Framework detection improvements
- [ ] Documentation updates
- [ ] Release preparation

---

**Plan Created**: 2025-10-23
**Target Release**: November 2025 (4 weeks)
**Next Review**: After Week 1 completion
