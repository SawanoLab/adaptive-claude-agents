# v0.7.0-beta Week 2 Development Plan

**Version**: v0.7.0-beta (継続)
**Duration**: Week 2 (7 days)
**Focus**: Cache Optimization & File Monitoring
**Started**: 2025-10-23

---

## 📋 Week 2 Overview

Week 1でキャッシングシステムの基礎実装が完了し、11/11フレームワークで500μs未満を達成しました。Week 2では、キャッシュの実用性を高め、実際のワークフローでの性能向上を目指します。

### Week 1の成果
- ✅ DetectionCache実装（mtime-based invalidation）
- ✅ 78-88%の性能向上（450μs → 10μs on cache hit）
- ✅ 11/11フレームワーク < 500μs（目標9/11を超過達成）
- ✅ 213/213テスト合格

### Week 2の目標
1. **キャッシュヒット率の最適化**（80% → 90%+）
2. **ファイル監視による自動無効化**（リアルタイム検知）
3. **メモリ使用量の最適化**（大規模プロジェクト対応）
4. **ウォッチモードとの統合**（Claude Code連携）

---

## 📅 Week 2 Timeline

### Day 1-2: Cache Hit Rate Analysis & Improvement
**Goal**: キャッシュヒット率を80%から90%+に向上

#### Day 1: 現状分析
- [ ] 実際のワークフローでキャッシュヒット率を測定
- [ ] キャッシュミスの原因を分類（false invalidation, cold start, etc）
- [ ] ボトルネック特定（どのファイル変更が最も頻繁か）
- [ ] 分析レポート作成

#### Day 2: 改善実装
- [ ] Smart invalidation実装（変更ファイルが検出に無関係ならキャッシュ維持）
- [ ] Selective monitoring（検出に関係するファイルのみ監視）
- [ ] Cache warming（頻繁にアクセスされるプロジェクトを事前キャッシュ）
- [ ] ヒット率改善の検証

**Success Criteria**:
- キャッシュヒット率: 80% → 90%+
- False invalidation: < 5%

---

### Day 3-4: File Monitoring & Auto Invalidation
**Goal**: ファイル変更を自動検知してキャッシュを無効化

#### Day 3: 設計
- [ ] ファイル監視アーキテクチャ設計
  - `watchdog` vs `inotify` vs `polling`の比較
  - macOS (FSEvents), Linux (inotify), Windows (ReadDirectoryChangesW) 対応
- [ ] 監視対象ファイルの選定ロジック
- [ ] 無効化トリガーの判定ロジック
- [ ] 設計ドキュメント作成

#### Day 4: 実装
- [ ] FileWatcherクラス実装（~200 lines）
- [ ] キャッシュとの統合（auto-invalidation）
- [ ] バックグラウンド監視スレッド
- [ ] リソース使用量の制限（CPU, メモリ）
- [ ] テスト作成（ファイル変更シミュレーション）

**Success Criteria**:
- ファイル変更から100ms以内にキャッシュ無効化
- CPU使用率: < 1% (idle時)
- メモリ使用量: < 10MB

---

### Day 5-6: Memory Optimization
**Goal**: 大規模プロジェクト（10,000+ files）でもメモリ効率よく動作

#### Day 5: メモリプロファイリング
- [ ] 大規模プロジェクトでのメモリ使用量測定
  - 小規模（~100 files）
  - 中規模（~1,000 files）
  - 大規模（~10,000 files）
- [ ] メモリリーク検出（`memory_profiler`）
- [ ] ボトルネック特定

#### Day 6: 最適化実装
- [ ] Cache size limit実装（LRU eviction）
- [ ] Lazy loading（必要なデータのみ読み込み）
- [ ] String interning（重複文字列の削減）
- [ ] JSON serialization最適化（`orjson`等の検討）
- [ ] メモリ使用量の再測定

**Success Criteria**:
- 10,000 filesプロジェクト: メモリ使用量 < 50MB
- LRU eviction動作確認（100キャッシュエントリ制限）

---

### Day 7: Testing & Documentation
**Goal**: Week 2の変更を統合し、品質を保証

- [ ] 全テストスイート実行（213+ tests）
- [ ] 新機能のテストカバレッジ確認（> 70%）
- [ ] パフォーマンスベンチマーク再実行
  - Cache hit rate: 90%+
  - Cold start: < 500μs (11/11 frameworks)
  - Cache hit: < 10μs
- [ ] Week 2完了レポート作成
- [ ] ドキュメント更新
  - CHANGELOG.md
  - Cache usage guide
  - Performance tuning tips

**Success Criteria**:
- 全テスト合格（0 failures）
- カバレッジ: 70%+
- ドキュメント完備

---

## 🎯 Week 2 Success Metrics

### Performance Targets
| Metric | Week 1 Baseline | Week 2 Goal | Stretch Goal |
|--------|----------------|-------------|--------------|
| Cache hit rate | 80% | 90% | 95% |
| Cold start (avg) | 450μs | < 500μs | < 400μs |
| Cache hit (avg) | 10μs | < 10μs | < 5μs |
| Memory usage (10k files) | N/A | < 50MB | < 30MB |
| File change detection | N/A | < 100ms | < 50ms |

### Quality Targets
- Test pass rate: 100%
- Test coverage: > 70%
- Code quality: No regressions
- Documentation: Complete

---

## 🛠️ Technical Stack (Week 2)

### New Dependencies (検討中)
- **watchdog** (3.0+): Cross-platform file monitoring
- **orjson** (optional): Fast JSON serialization
- **memory_profiler**: Memory usage analysis

### Development Tools
- pytest-benchmark: Performance testing
- memory_profiler: Memory profiling
- cProfile: CPU profiling

---

## 📊 Risk Management

### リスク1: File monitoring performance overhead
**Probability**: Medium
**Impact**: High
**Mitigation**:
- Selective monitoring（必要なファイルのみ）
- Debouncing（連続変更を1回にまとめる）
- CPU/メモリ制限の実装

### リスク2: Cross-platform compatibility
**Probability**: Medium
**Impact**: Medium
**Mitigation**:
- `watchdog`ライブラリ使用（クロスプラットフォーム対応済み）
- 各OSでのテスト実施
- フォールバック実装（polling）

### リスク3: Memory usage in large projects
**Probability**: Low
**Impact**: Medium
**Mitigation**:
- Early profiling（Day 5）
- LRU eviction実装
- メモリ制限の明示

---

## 📝 Deliverables

### Code
1. **Enhanced DetectionCache** (~100 lines追加)
   - Smart invalidation logic
   - Cache warming
   - LRU eviction

2. **FileWatcher** (~200 lines)
   - Cross-platform file monitoring
   - Auto-invalidation integration
   - Resource limits

3. **Memory optimizations** (~50 lines)
   - Lazy loading
   - String interning
   - JSON optimization

### Documentation
1. **Week 2 Completion Report** (~700 lines)
2. **Cache Performance Guide** (~300 lines)
3. **File Monitoring Design Doc** (~400 lines)
4. **CHANGELOG.md update**

### Tests
- File monitoring tests (~100 lines)
- Cache hit rate tests (~50 lines)
- Memory usage tests (~50 lines)

---

## 🔗 Dependencies

### Week 1の成果物（前提）
- ✅ DetectionCache class
- ✅ Mtime-based cache key generation
- ✅ CLI flags (--no-cache, --cache-clear, --cache-stats)

### Week 3への引き継ぎ
- Optimized cache system
- File monitoring infrastructure
- Performance baseline for parallel detection

---

## 📚 References

- [watchdog documentation](https://python-watchdogs.readthedocs.io/)
- [Python memory profiler](https://pypi.org/project/memory-profiler/)
- [LRU Cache implementation patterns](https://realpython.com/lru-cache-python/)
- [File system events: FSEvents (macOS), inotify (Linux)](https://docs.python.org/3/library/os.html)

---

## 🚀 Getting Started (Day 1)

```bash
# Day 1: Cache hit rate analysis
cd /path/to/adaptive-claude-agents

# Run detection with cache stats
python3 skills/project-analyzer/detect_stack.py . --cache-stats

# Simulate real-world workflow
for i in {1..10}; do
  python3 skills/project-analyzer/detect_stack.py .
  echo "Run $i complete"
  sleep 1
done

# Check cache hit rate
python3 skills/project-analyzer/detect_stack.py . --cache-stats

# Profile memory usage
python3 -m memory_profiler skills/project-analyzer/detect_stack.py .
```

---

**Status**: Week 2 Day 1 開始準備完了
**Next Action**: キャッシュヒット率の現状分析を開始

Repository: https://github.com/SawanoLab/adaptive-claude-agents
